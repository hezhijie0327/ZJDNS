# ZJDNS Server

ğŸš€ é«˜æ€§èƒ½é€’å½’DNSè§£ææœåŠ¡å™¨ï¼ŒåŸºäºGoè¯­è¨€å¼€å‘ï¼Œæ”¯æŒRedisç¼“å­˜ã€DNSSECéªŒè¯ã€ECSç­‰é«˜çº§åŠŸèƒ½ã€‚

> âš ï¸ **è­¦å‘Š**
> æœ¬é¡¹ç›®ä¸º Vibe Coding äº§ç‰©ï¼Œä»£ç ç»“æ„å¤æ‚ä¸”æœªç»å……åˆ†ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼Œè¯·å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒ

## âœ¨ åŠŸèƒ½ç‰¹ç‚¹

### ğŸ”§ æ ¸å¿ƒåŠŸèƒ½
- **é€’å½’DNSè§£æ**ï¼šå®Œæ•´å®ç°DNSé€’å½’æŸ¥è¯¢ç®—æ³•ï¼Œä»æ ¹æœåŠ¡å™¨å¼€å§‹é€çº§è§£æ
- **æ™ºèƒ½åè®®åå•†**ï¼šåŒæ—¶æ”¯æŒUDPå’ŒTCPåè®®ï¼Œ**å½“UDPå“åº”è¢«æˆªæ–­æˆ–è¶…è¿‡ç¼“å†²åŒºå¤§å°æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°TCPåè®®**ï¼Œç¡®ä¿å¤§å“åº”æ•°æ®çš„å®Œæ•´ä¼ è¾“
- **CNAMEé“¾è§£æ**ï¼šæ™ºèƒ½å¤„ç†CNAMEè®°å½•é“¾ï¼Œé˜²æ­¢å¾ªç¯å¼•ç”¨ï¼Œæ”¯æŒå¤šçº§CNAMEè§£æ
- **å¹¶å‘æŸ¥è¯¢**ï¼šé«˜æ€§èƒ½å¹¶å‘å¤„ç†ï¼Œæ”¯æŒè¿æ¥æ± ç®¡ç†
- **DNSé‡å†™åŠŸèƒ½**ï¼šæ”¯æŒç²¾ç¡®åŒ¹é…ã€å‰ç¼€ã€åç¼€å’Œæ­£åˆ™è¡¨è¾¾å¼é‡å†™è§„åˆ™ï¼Œå¯å®ç°åŸŸåè¿‡æ»¤å’Œé‡å®šå‘
- **æ··åˆæ¨¡å¼**ï¼šå¯åŒæ—¶é…ç½®ä¸Šæ¸¸DNSæœåŠ¡å™¨å’Œé€’å½’è§£æå™¨ï¼Œå®ç°çµæ´»çš„æŸ¥è¯¢ç­–ç•¥

### ğŸ›¡ï¸ å®‰å…¨ä¸é˜²å¾¡ç‰¹æ€§
- **DNSåŠ«æŒé¢„é˜²**ï¼šä¸»åŠ¨æ£€æµ‹å¹¶æ™ºèƒ½åº”å¯¹æ¥è‡ªæ ¹æœåŠ¡å™¨çš„è¶Šæƒå“åº”ã€‚
  - **ç¬¬ä¸€æ­¥**ï¼šå½“æ£€æµ‹åˆ°æ ¹æœåŠ¡å™¨ç›´æ¥è¿”å›éæ ¹åŸŸåçš„æœ€ç»ˆè®°å½•æ—¶ï¼Œåˆ¤å®šä¸ºDNSåŠ«æŒã€‚
  - **ç¬¬äºŒæ­¥**ï¼š**è‡ªåŠ¨åˆ‡æ¢åˆ°TCPåè®®è¿›è¡Œé‡è¯•**ï¼Œä»¥ç»•è¿‡å¸¸è§çš„UDPæ±¡æŸ“ã€‚
  - **ç¬¬ä¸‰æ­¥**ï¼šå¦‚æœTCPæŸ¥è¯¢ç»“æœ**ä¾ç„¶**è¢«åŠ«æŒï¼Œåˆ™å½»åº•æ‹’ç»è¯¥å“åº”ï¼Œä»æºå¤´ä¸Šé˜²æ­¢æ±¡æŸ“ã€‚
- **DNSSECéªŒè¯**ï¼šå®Œæ•´çš„DNSSECæ”¯æŒå’ŒéªŒè¯ï¼Œå¯è®¾ç½®æœåŠ¡å™¨å¼ºåˆ¶éªŒè¯ï¼Œæ”¯æŒADæ ‡å¿—ä¼ é€’
- **ECSæ”¯æŒ**ï¼šEDNS Client Subnetï¼Œæä¾›åœ°ç†ä½ç½®æ„ŸçŸ¥çš„è§£æï¼Œæ”¯æŒ`auto`ã€`auto_v4`ã€`auto_v6`è‡ªåŠ¨æ£€æµ‹æˆ–æ‰‹åŠ¨CIDRé…ç½®
- **é€’å½’æ·±åº¦ä¿æŠ¤**ï¼šé˜²æ­¢æ¶æ„é€’å½’æŸ¥è¯¢æ”»å‡»ï¼Œå¯é…ç½®æœ€å¤§é€’å½’æ·±åº¦
- **IPè¿‡æ»¤**ï¼šåŸºäºCIDRçš„IPè¿‡æ»¤åŠŸèƒ½ï¼Œå¯åŒºåˆ†å¯ä¿¡IPå’Œéå¯ä¿¡IPï¼Œå®ç°ç²¾ç»†åŒ–æµé‡æ§åˆ¶
- **å†…å­˜å®‰å…¨**ï¼šé‡‡ç”¨å¯¹è±¡æ± ç®¡ç†ï¼Œä¿®å¤æ½œåœ¨å†…å­˜æ³„æ¼ï¼Œæå‡é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§

### ğŸ’¾ ç¼“å­˜ç³»ç»Ÿ
- **åŒæ¨¡å¼è¿è¡Œ**ï¼š
  - **æ— ç¼“å­˜æ¨¡å¼**ï¼šé€‚åˆæµ‹è¯•ç¯å¢ƒï¼Œé›¶é…ç½®å¯åŠ¨ï¼Œçº¯é€’å½’è§£æ
  - **Redisç¼“å­˜æ¨¡å¼**ï¼šç”Ÿäº§ç¯å¢ƒæ¨èï¼Œæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ•°æ®æŒä¹…åŒ–
- **æ™ºèƒ½TTLç®¡ç†**ï¼šçµæ´»çš„TTLç­–ç•¥ï¼Œæ”¯æŒæœ€å°/æœ€å¤§TTLé™åˆ¶
- **è¿‡æœŸç¼“å­˜æœåŠ¡ (Serve Stale)**ï¼šåœ¨ä¸Šæ¸¸æœåŠ¡å™¨ä¸å¯ç”¨æ—¶ï¼Œæä¾›è¿‡æœŸç¼“å­˜æœåŠ¡ï¼Œæå¤§æé«˜ç³»ç»Ÿå¯ç”¨æ€§
- **é¢„å–æœºåˆ¶**ï¼šåå°è‡ªåŠ¨åˆ·æ–°å³å°†è¿‡æœŸçš„ç¼“å­˜ï¼Œå‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´
- **ECSæ„ŸçŸ¥ç¼“å­˜**ï¼šåŸºäºå®¢æˆ·ç«¯åœ°ç†ä½ç½®ï¼ˆEDNS Client Subnetï¼‰çš„ç¼“å­˜åˆ†åŒºï¼Œæä¾›ç²¾å‡†çš„æœ¬åœ°åŒ–è§£æ
- **è®¿é—®èŠ‚æµ**ï¼šå¯¹ç¼“å­˜çš„è®¿é—®æ—¶é—´æ›´æ–°æ“ä½œè¿›è¡ŒèŠ‚æµï¼Œå‡è½»Rediså‹åŠ›

### ğŸ•µï¸ è¯·æ±‚è¿½è¸ªç³»ç»Ÿ
- **å…¨é“¾è·¯è¿½è¸ª**ï¼šä¸ºæ¯ä¸ªDNSè¯·æ±‚ç”Ÿæˆå”¯ä¸€IDï¼Œè¯¦ç»†è®°å½•å¤„ç†è¿‡ç¨‹ä¸­çš„æ¯ä¸€æ­¥æ“ä½œå’Œè€—æ—¶ã€‚
- **æ™ºèƒ½æ—¥å¿—**ï¼šåœ¨`DEBUG`çº§åˆ«ä¸‹ï¼Œè¾“å‡ºå¸¦æ—¶é—´æˆ³çš„è¯·æ±‚å¤„ç†æ­¥éª¤ï¼Œæå¤§ç®€åŒ–è°ƒè¯•å’Œæ€§èƒ½åˆ†æã€‚
- **æ‘˜è¦æŠ¥å‘Š**ï¼šåœ¨`INFO`çº§åˆ«ä¸‹ï¼Œè¾“å‡ºè¯·æ±‚å¤„ç†æ‘˜è¦ï¼ŒåŒ…æ‹¬ç¼“å­˜å‘½ä¸­çŠ¶æ€ã€æ€»è€—æ—¶ã€ä½¿ç”¨çš„ä¸Šæ¸¸æœåŠ¡å™¨ç­‰å…³é”®ä¿¡æ¯ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DNS Client    â”‚â”€â”€â”€â–¶â”‚        ZJDNS Server           â”‚â”€â”€â”€â–¶â”‚  Upstream DNS   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                               â”‚    â”‚   (Root/Auth)   â”‚
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚  â”‚   Cache     â”‚  â”‚  Conn   â”‚  â”‚
                       â”‚  â”‚  (Redis)    â”‚  â”‚  Pool   â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”€â”€â”€â–¶â”‚   DNSSEC Val    â”‚
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚  â”‚  IP Filter  â”‚  â”‚ Signal  â”‚  â”‚
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Handler â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”€â”€â”€â–¶â”‚ Background Task â”‚
                       â”‚  â”‚ DNS Rewriterâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚   Manager       â”‚
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Logging â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                       â”‚  â”‚ DNS Hijack  â”‚               â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  â”‚ Prevention  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â–¶â”‚    Root Zone    â”‚
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚    â”‚    Check        â”‚
                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚  â”‚ Request     â”‚               â”‚
                       â”‚  â”‚ Tracker     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â–¶â”‚    ECS Mgr      â”‚
                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ› ï¸ é…ç½®é€‰é¡¹

### æ ¸å¿ƒé…ç½®
- **ç½‘ç»œè®¾ç½®**ï¼šç«¯å£ã€IPv6æ”¯æŒã€é»˜è®¤ECSå­ç½‘ï¼ˆæ”¯æŒ`auto`, `auto_v4`, `auto_v6`ï¼‰
- **TTLç­–ç•¥**ï¼šé»˜è®¤TTLã€è¿‡æœŸç¼“å­˜æœåŠ¡å‚æ•°ï¼ˆStale TTL, Stale Max Ageï¼‰
- **æ—¥å¿—çº§åˆ«**ï¼šæ”¯æŒ`none`ã€`error`ã€`warn`ã€`info`ã€`debug`äº”çº§æ—¥å¿—ï¼Œå¸¦é¢œè‰²å’Œemojiè¾“å‡º

### é«˜çº§åŠŸèƒ½
- **IPè¿‡æ»¤**ï¼šé€šè¿‡`trusted_cidr_file`é…ç½®å¯ä¿¡IPæ®µï¼Œå¯ç”¨åå¯å¯¹A/AAAAè®°å½•è¿›è¡Œä¿¡ä»»åˆ†æ
- **DNSé‡å†™**ï¼šæ”¯æŒå¤šç§é‡å†™è§„åˆ™ï¼Œå¯å®ç°åŸŸåé‡å®šå‘ã€å¹¿å‘Šè¿‡æ»¤ï¼ˆå¦‚é‡å†™åˆ°127.0.0.1ï¼‰ç­‰
- **ä¸Šæ¸¸æœåŠ¡å™¨**ï¼šå¯é…ç½®å¤šä¸ªä¸Šæ¸¸DNSæœåŠ¡å™¨ï¼Œè®¾ç½®ä¿¡ä»»ç­–ç•¥ï¼ˆ`all`, `trusted_only`, `untrusted_only`ï¼‰
- **DNSåŠ«æŒé¢„é˜²**ï¼šåœ¨ `features` é…ç½®å—ä¸­è®¾ç½® `hijack_protection: true` å³å¯å¯ç”¨ã€‚

### æ€§èƒ½è°ƒä¼˜
- **å¹¶å‘æ§åˆ¶**ï¼šç³»ç»Ÿæœ€å¤§å¹¶å‘æ•°å›ºå®šä¸º1000
- **åå°ä»»åŠ¡**ï¼šåå°ä»»åŠ¡å¤„ç†workeræ•°é‡æ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨è°ƒæ•´
- **ç¼“å­˜åˆ·æ–°**ï¼šå¯é…ç½®ç¼“å­˜é¢„å–å’Œåˆ·æ–°ç­–ç•¥ï¼Œä»¥åŠRedisæ›´æ–°èŠ‚æµæ—¶é—´ï¼ˆæ¯«ç§’çº§ï¼‰
- **æŸ¥è¯¢è¶…æ—¶**ï¼šå…¨å±€æŸ¥è¯¢è¶…æ—¶å›ºå®šä¸º5ç§’

## ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹

### ç”Ÿæˆç¤ºä¾‹é…ç½®æ–‡ä»¶
```bash
./zjdns -generate-config > config.json
```

### å¯åŠ¨æœåŠ¡å™¨
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆçº¯é€’å½’æ¨¡å¼ï¼Œæ— ç¼“å­˜ï¼‰
./zjdns

# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ï¼ˆæ¨èï¼‰
./zjdns -config config.json
```

## ğŸ“ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®ï¼š
- [miekg/dns](https://github.com/miekg/dns) - Go DNSåº“
- [redis/go-redis](https://github.com/redis/go-redis) - Redis Goå®¢æˆ·ç«¯
