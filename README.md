# ZJDNS Server

🚀 高性能递归DNS解析服务器，基于Go语言开发，支持Redis缓存、DNSSEC验证、ECS等高级功能。

> ⚠️ **警告**
> 本项目为 Vibe Coding 产物，代码结构复杂且未经充分生产环境验证，请勿用于生产环境

## ✨ 功能特点

### 🔧 核心功能
- **递归DNS解析**：完整实现DNS递归查询算法，从根服务器开始逐级解析
- **智能协议协商**：同时支持UDP和TCP协议，**当UDP响应被截断或超过缓冲区大小时，自动回退到TCP协议**，确保大响应数据的完整传输
- **CNAME链解析**：智能处理CNAME记录链，防止循环引用，支持多级CNAME解析
- **并发查询**：高性能并发处理，支持连接池管理
- **DNS重写功能**：支持精确匹配、前缀、后缀和正则表达式重写规则，可实现域名过滤和重定向
- **混合模式**：可同时配置上游DNS服务器和递归解析器，实现灵活的查询策略

### 🛡️ 安全与防御特性
- **DNS劫持预防**：主动检测并智能应对来自根服务器的越权响应。
  - **第一步**：当检测到根服务器直接返回非根域名的最终记录时，判定为DNS劫持。
  - **第二步**：**自动切换到TCP协议进行重试**，以绕过常见的UDP污染。
  - **第三步**：如果TCP查询结果**依然**被劫持，则彻底拒绝该响应，从源头上防止污染。
- **DNSSEC验证**：完整的DNSSEC支持和验证，可设置服务器强制验证，支持AD标志传递
- **ECS支持**：EDNS Client Subnet，提供地理位置感知的解析，支持`auto`、`auto_v4`、`auto_v6`自动检测或手动CIDR配置
- **递归深度保护**：防止恶意递归查询攻击，可配置最大递归深度
- **IP过滤**：基于CIDR的IP过滤功能，可区分可信IP和非可信IP，实现精细化流量控制
- **内存安全**：采用对象池管理，修复潜在内存泄漏，提升长时间运行稳定性

### 💾 缓存系统
- **双模式运行**：
  - **无缓存模式**：适合测试环境，零配置启动，纯递归解析
  - **Redis缓存模式**：生产环境推荐，支持分布式部署，数据持久化
- **智能TTL管理**：灵活的TTL策略，支持最小/最大TTL限制
- **过期缓存服务 (Serve Stale)**：在上游服务器不可用时，提供过期缓存服务，极大提高系统可用性
- **预取机制**：后台自动刷新即将过期的缓存，减少用户等待时间
- **ECS感知缓存**：基于客户端地理位置（EDNS Client Subnet）的缓存分区，提供精准的本地化解析
- **访问节流**：对缓存的访问时间更新操作进行节流，减轻Redis压力

### 🕵️ 请求追踪系统
- **全链路追踪**：为每个DNS请求生成唯一ID，详细记录处理过程中的每一步操作和耗时。
- **智能日志**：在`DEBUG`级别下，输出带时间戳的请求处理步骤，极大简化调试和性能分析。
- **摘要报告**：在`INFO`级别下，输出请求处理摘要，包括缓存命中状态、总耗时、使用的上游服务器等关键信息。

## 🏗️ 系统架构

```
┌─────────────────┐    ┌───────────────────────────────┐    ┌─────────────────┐
│   DNS Client    │───▶│        ZJDNS Server           │───▶│  Upstream DNS   │
└─────────────────┘    │                               │    │   (Root/Auth)   │
                       │  ┌─────────────┐  ┌─────────┐  │    └─────────────────┘
                       │  │   Cache     │  │  Conn   │  │
                       │  │  (Redis)    │  │  Pool   │  │    ┌─────────────────┐
                       │  └─────────────┘  └─────────┘  │───▶│   DNSSEC Val    │
                       │  ┌─────────────┐  ┌─────────┐  │    └─────────────────┘
                       │  │  IP Filter  │  │ Signal  │  │
                       │  └─────────────┘  │ Handler │  │    ┌─────────────────┐
                       │  ┌─────────────┐  └─────────┘  │───▶│ Background Task │
                       │  │ DNS Rewriter│  ┌─────────┐  │    │   Manager       │
                       │  └─────────────┘  │ Logging │  │    └─────────────────┘
                       │  ┌─────────────┐  └─────────┘  │
                       │  │ DNS Hijack  │               │    ┌─────────────────┐
                       │  │ Prevention  │───────────────│───▶│    Root Zone    │
                       │  └─────────────┘               │    │    Check        │
                       │  ┌─────────────┐               │    └─────────────────┘
                       │  │ Request     │               │
                       │  │ Tracker     │───────────────│───▶│    ECS Mgr      │
                       │  └─────────────┘               │    └─────────────────┘
                       └───────────────────────────────┘
```

## 🛠️ 配置选项

### 核心配置
- **网络设置**：端口、IPv6支持、默认ECS子网（支持`auto`, `auto_v4`, `auto_v6`）
- **TTL策略**：默认TTL、过期缓存服务参数（Stale TTL, Stale Max Age）
- **日志级别**：支持`none`、`error`、`warn`、`info`、`debug`五级日志，带颜色和emoji输出

### 高级功能
- **IP过滤**：通过`trusted_cidr_file`配置可信IP段，启用后可对A/AAAA记录进行信任分析
- **DNS重写**：支持多种重写规则，可实现域名重定向、广告过滤（如重写到127.0.0.1）等
- **上游服务器**：可配置多个上游DNS服务器，设置信任策略（`all`, `trusted_only`, `untrusted_only`）
- **DNS劫持预防**：在 `features` 配置块中设置 `hijack_protection: true` 即可启用。

### 性能调优
- **并发控制**：系统最大并发数固定为1000
- **后台任务**：后台任务处理worker数量根据CPU核心数自动调整
- **缓存刷新**：可配置缓存预取和刷新策略，以及Redis更新节流时间（毫秒级）
- **查询超时**：全局查询超时固定为5秒

## 📋 使用示例

### 生成示例配置文件
```bash
./zjdns -generate-config > config.json
```

### 启动服务器
```bash
# 使用默认配置（纯递归模式，无缓存）
./zjdns

# 使用配置文件启动（推荐）
./zjdns -config config.json
```

## 📝 许可证

本项目采用 MIT 许可证，详见 [LICENSE](LICENSE) 文件。

## 🙏 致谢

感谢以下开源项目：
- [miekg/dns](https://github.com/miekg/dns) - Go DNS库
- [redis/go-redis](https://github.com/redis/go-redis) - Redis Go客户端
