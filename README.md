# ZJDNS Server

🚀 高性能递归DNS解析服务器，基于Go语言开发，支持Redis缓存、DNSSEC验证、ECS等高级功能。

## ✨ 功能特点

### 🔧 核心功能
- **递归DNS解析**：完整实现DNS递归查询算法
- **双协议支持**：同时支持UDP和TCP协议
- **CNAME链解析**：智能处理CNAME记录链，防止循环引用
- **并发查询**：高性能并发处理，支持连接池管理
- **多上游策略**：支持`first_valid`、`prefer_trusted`、`round_robin`和`weighted`四种上游服务器选择策略
- **DNS重写功能**：支持精确匹配、前缀、后缀和正则表达式重写规则

### 💾 缓存系统
- **双模式运行**：
  - 无缓存模式：适合测试环境，零配置启动
  - Redis缓存模式：生产环境推荐，支持分布式部署
- **智能TTL管理**：灵活的TTL策略，支持最小/最大TTL限制
- **过期缓存服务**：Serve Stale功能，提高可用性
- **预取机制**：后台自动刷新即将过期的缓存
- **ECS感知缓存**：基于客户端地理位置的缓存分区

### 🔒 安全特性
- **DNSSEC验证**：完整的DNSSEC支持和验证，可设置服务器强制验证
- **ECS支持**：EDNS Client Subnet，提供地理位置感知的解析
- **递归深度保护**：防止恶意递归查询攻击
- **IP过滤**：基于CIDR的IP过滤功能，可区分中国IP和非中国IP
- **上游信任策略**：支持`all`、`cn_only`和`non_cn_only`三种信任策略

### 📊 监控统计
- **实时统计**：查询量、缓存命中率、错误率等
- **性能指标**：平均响应时间、QPS统计
- **彩色日志**：支持emoji和颜色的结构化日志输出
- **后台任务管理**：可配置的后台任务处理器，用于缓存刷新等

### ⚙️ 性能优化
- **动态连接池**：根据负载自动调整连接数量
- **对象池管理**：减少GC压力，提高内存使用效率
- **并发控制**：可配置的最大并发查询数
- **缓存更新节流**：减少Redis写入压力
- **高效缓存键生成**：优化的缓存键构建器

## 🏗️ 系统架构

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   DNS Client    │───▶│   ZJDNS Server   │───▶│  Upstream DNS   │
└─────────────────┘    │                  │    │   (Root/Auth)   │
                       │  ┌─────────────┐  │    └─────────────────┘
                       │  │   Cache     │  │
                       │  │  (Redis)    │  │    ┌─────────────────┐
                       │  └─────────────┘  │───▶│   DNSSEC Val    │
                       │  ┌─────────────┐  │    └─────────────────┘
                       │  │  IP Filter  │  │
                       │  └─────────────┘  │
                       │  ┌─────────────┐  │
                       │  │ DNS Rewriter│  │
                       │  └─────────────┘  │
                       └──────────────────┘
```

## 🛠️ 配置选项

### 核心配置
- **网络设置**：端口、IPv6支持、默认ECS子网
- **TTL策略**：默认TTL、最小/最大TTL、过期缓存服务参数
- **日志级别**：支持NONE、ERROR、WARN、INFO、DEBUG五级日志

### 高级功能
- **IP过滤**：通过`china_cidr.txt`配置中国IP段
- **DNS重写**：支持多种重写规则，可实现域名重定向、过滤等
- **上游服务器**：可配置多个上游DNS服务器，设置信任策略和优先级
- **连接池**：支持静态和动态连接池，优化网络连接

### 性能调优
- **并发控制**：最大并发查询数
- **连接池大小**：可配置最小/最大连接数
- **后台任务**：可调整后台任务处理worker数量
- **缓存刷新**：可配置缓存预取和刷新策略

## 📋 使用示例

### 生成示例配置文件
```bash
./zjdns -generate-config > config.json
```

### 启动服务器
```bash
# 使用默认配置（纯递归模式）
./zjdns

# 使用配置文件
./zjdns -config config.json
```

## 📝 许可证

本项目采用 MIT 许可证，详见 [LICENSE](LICENSE) 文件。

## 🙏 致谢

感谢以下开源项目：
- [miekg/dns](https://github.com/miekg/dns) - Go DNS库
- [go-redis/redis](https://github.com/go-redis/redis) - Redis Go客户端
